{% extends "base_template.html" %}

{% block title %}Create{% endblock %}

{% block head %}
<link href="{{ url_for('static', filename='css/toggle.css') }}" rel="stylesheet" media="screen" />
<script src="{{ url_for('static', filename='js/turf.js') }} "></script>
<script src="{{ url_for('static', filename='js/problem_utils.js') }}"></script>
{% endblock %}

{% block content %}
<div id="holder">
  <div id="body">
    <div class="container">
      <br />
      <div class="row text-center">
        <div class="col-xs-1 col-sm-1 col-md-4 col-lg-4 col-xl-4"></div>
        <div class="col-xs-10 col-sm-10 col-md-4 col-lg-4 col-xl-4">
          <div class="row text-center">
            <div class="col">
              <p><a href="/">Home</a></p>
            </div>
            <div class="col">
              <p><a href="/create?options=boulder">Back</a></p>
            </div>
          </div>
        </div>
        <div class="col-xs-1 col-sm-1 col-md-4 col-lg-4 col-xl-4"></div>
      </div>
      <!-- <br /> -->
      <div class="row">
        <div class="col-sm">
          <div style="text-align: center;">
            <h3>
              Section: {{ wall_name }}
            </h3>
          </div>
          <!-- Default switch -->
          <div class="custom-control custom-switch">
            <input type="checkbox" checked class="custom-control-input" id="customSwitches">
            <label class="custom-control-label" for="customSwitches">Hold detection</label>
          </div>
          <br />
          <img id="wall-image" src="{{ wall_image }}" alt="wall section" />
          <canvas id="wall-canvas"></canvas>
        </div>
        <br />
          <div class="col-sm">
            <div style="text-align: center;">
              <h5>Hold type</h5>
              <div class="row">
                <div class="col-4">
                  <input type="radio" name="hold_type" value="#00ff00" checked />
                  Start<br />
                </div>
                <div class="col-4">
                  <input type="radio" name="hold_type" value="#0000ff" />
                  Normal<br />
                </div>
                <div class="col-4">
                  <input type="radio" name="hold_type" value="#ff0000" />
                  Top<br />
                </div>
              </div>
            </div>
          </div>
      </div>
      <br />
      <br />
      <div class="container">
        <div class="row">
          <div class="col-xs-12 col-md-6">
            <div class="row" style="display: flex;">
              <div class="col-4" style="display: grid;">
                <button class="btn btn-outline-dark" onclick="undoMove()">
                  Undo
                </button>
              </div>
              <div class="col-4">
                <form action="/save_boulder?section={{section}}" onsubmit="return validateForm()" method="POST" style="display: grid;">
                  <input class="btn btn-outline-dark" type="submit" value="Done" name="Submit"
                    onclick="return setHolds();" />
                  <input type="hidden" name="holds" id="holds-array" value="" />
                </form>
              </div>
              <div class="col-4" style="display: grid;">
                <a href="/" class="btn btn-outline-dark">Cancel</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  window.onload = () => {
    radius = '{{ radius }}';
    var img = document.getElementById("wall-image");
    var cnvs = document.getElementById("wall-canvas");

    var wall_hold_data = '{{ hold_data | tojson | safe}}';
    var parsed_data = JSON.parse(wall_hold_data);
    polys = parsed_data.holds;
    ratio = img.offsetWidth / img.naturalWidth;
    for (let index = 0; index < polys.length; index++) {
        // Adjust ratio
        for (let i = 0; i < polys[index].length; i++) {
            polys[index][i][0] *= ratio;
            polys[index][i][1] *= ratio;
        }
    }
    cnvs.style.position = "absolute";
    cnvs.style.left = img.offsetLeft + "px";
    cnvs.style.top = img.offsetTop + "px";
    cnvs.width = img.offsetWidth;
    cnvs.height = img.offsetHeight;

    var ctx = cnvs.getContext("2d");
    ctx.width = cnvs.width;
    ctx.height = cnvs.height;

    fillCanvasWithGray(ctx, cnvs);
    // listen for mouse events
    cnvs.onmousedown = myDown;
    cnvs.onmouseup = myUp;
    cnvs.onmousemove = myMove;
  };
</script>
{% endblock %}

{% block styles %}
<style>
  img {
    margin-left: auto;
    margin-right: auto;
    display: block;
    width: 90%;
  }

  @media (max-width: 600px) {
    img {
      width: 95%;
      margin-left: auto;
      margin-right: auto;
    }
  }

</style>
{% endblock %}